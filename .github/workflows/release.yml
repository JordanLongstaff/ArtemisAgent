name: Upload Release

on:
  pull_request:
    branches: [ "main" ]

jobs:
  release:
    runs-on: ubuntu-latest
    environment: Production
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Generate secret files
        run: |
          echo ${{ secrets.GOOGLE_SERVICES }} | base64 -d > ${{ github.workspace }}/app/google-services.json

      - name: Authenticate for Firebase
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ secrets.WIF_PROJECT_ID }}/locations/global/workloadIdentityPools/${{ secrets.WIF_POOL }}/providers/${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.FIREBASE_SA_USER }}@${{ secrets.FIREBASE_SA_PROJECT }}.iam.gserviceaccount.com

      - name: Set Firebase Project
        uses: w9jds/firebase-action@v13.33.0
        with:
          args: use ${{ secrets.FIREBASE_SA_PROJECT }}

      - name: Get Firebase Remote Config
        uses: w9jds/firebase-action@v13.33.0
        with:
          args: remoteconfig:get -o app/remote-config.json

      - name: Show File Permissions
        run: |
          stat app/remote-config.json
          stat app/build.gradle.kts

      - name: Obtain Ownership
        run: sudo chown -R $(whoami):$(id -g) app/remote-config.json

      - name: Update Version Code for Security Parameter
        uses: tnikFi/json-file-transform@v2
        with:
          files: app/remote-config.json
          key-value-pairs: parameterGroups.required_versions.parameters.required_version_security.conditionalValues.Everyone.rolloutValue.value=5
