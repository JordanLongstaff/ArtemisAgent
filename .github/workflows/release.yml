# This workflow uses actions that are not certified by GitHub.
# They are provided by a third-party and are governed by
# separate terms of service, privacy policy, and support
# documentation.
# This workflow will build a Java project with Gradle and cache/restore any dependencies to improve the workflow execution time
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-java-with-gradle

name: Upload Release

on:
  workflow_dispatch:
    inputs:
      versionName:
        description: Version name (remember to update changelog)
        required: true
      artemisSoftUpdate:
        description: Artemis SBS latest version
      artemisRequiredUpdate:
        description: Version required to support Artemis
        type: boolean
      securityRequiredUpdate:
        description: Version required for security
        type: boolean

jobs:
  wait-for-prerequisites:
    name: 'Wait for prerequisite actions'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for build
        uses: johannesvedder/await-workflow@v1
        with:
          workflowId: gradle.yml
          timeoutSeconds: 3600

      - name: Wait for instrumented tests
        uses: johannesvedder/await-workflow@v1
        with:
          workflowId: instrumented-tests.yml
          timeoutSeconds: 3600

  release:
    runs-on: ubuntu-latest
    needs: wait-for-prerequisites
    environment: Production
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4

      - name: Generate secret files
        run: |
          echo ${{ secrets.KEYSTORE_PROPERTIES }} | base64 -d > ${{ github.workspace }}/keystore.properties
          echo ${{ secrets.KEYSTORE_FILE }} | base64 -d > ${{ github.workspace }}/app/artemis-agent-keystore.jks
          echo ${{ secrets.GOOGLE_SERVICES }} | base64 -d > ${{ github.workspace }}/app/google-services.json
          echo ${{ secrets.FASTLANE_JSON }} | base64 -d > ${{ github.workspace }}/app/artemis-agent-fastlane.json

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # Configure Gradle for optimal use in GitHub Actions, including caching of downloaded dependencies.
      # See: https://github.com/gradle/actions/blob/main/setup-gradle/README.md
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Get app version code
        id: version
        uses: ltDino/android-get-version-action@v1.0
        with:
          gradlePath: app/build.gradle.kts

      - name: Increment app version code
        id: nextVersion
        run: echo "versionCode=$((${{ steps.version.outputs.versionCode }}+1))" >> "$GITHUB_OUTPUT"

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2.2
          bundler-cache: true

      - name: Setup Fastlane
        uses: tashi-iu/setup-fastlane@v1

      - name: Initialize Fastlane
        run: fastlane supply init

      - name: Update changelog
        run: |
          rm fastlane/metadata/android/en-US/changelogs/*.txt
          echo "${{ vars.CHANGELOG }}" > fastlane/metadata/android/en-US/changelogs/default.txt

      - name: Authenticate for Firebase
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.WORKLOAD_IDENTITY_PROVIDER }}

      - name: Get Firebase Remote Config
        uses: w9jds/firebase-action@v13.31.1
        with:
          args: remoteconfig:get -o app/remote-config.json

      - name: Update Artemis Version Parameter
        if: ${{ inputs.artemisSoftUpdate }}
        uses: jossef/action-set-json-field@v2.2
        with:
          file: app/remote-config.json
          field: parameters.artemis_latest_version.conditionalValues.Everyone.rolloutValue.value
          value: ${{ inputs.artemisSoftUpdate }}

      - name: Update Version Code for Artemis Parameter
        if: ${{ inputs.artemisRequiredUpdate }}
        uses: jossef/action-set-json-field@v2.2
        with:
          file: app/remote-config.json
          field: parameterGroups.required_versions.parameters.required_version_artemis.conditionalValues.Everyone.rolloutValue.value
          value: ${{ steps.nextVersion.outputs.versionCode }}

      - name: Update Version Code for Security Parameter
        if: ${{ inputs.securityRequiredUpdate }}
        uses: jossef/action-set-json-field@v2.2
        with:
          file: app/remote-config.json
          field: parameterGroups.required_versions.parameters.required_version_security.conditionalValues.Everyone.rolloutValue.value
          value: ${{ steps.nextVersion.outputs.versionCode }}

      - name: Publish Firebase Remote Config
        if: ${{ inputs.securityRequiredUpdate || inputs.artemisRequiredUpdate || inputs.artemisSoftUpdate }}
        uses: w9jds/firebase-action@v13.31.1
        with:
          args: deploy --only remoteconfig

      - name: Bundle and Upload
        run: fastlane android deploy version:${{ inputs.versionName }}

      - name: Commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Release version ${{ inputs.versionName }}
          commit_options: "--no-verify --signoff"
          commit_user_name: ${{ github.triggering_actor }}
          commit_user_email: ${{ github.triggering_actor }}@users.noreply.github.com
          branch: main

      - name: Tag
        uses: laputansoft/github-tag-action@v4.6
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          tag: v${{ inputs.versionName }}
          release_branches: main
