name: Upload Release

on:
  workflow_dispatch:
    inputs:
      versionName:
        description: Version name (remember to update changelog)
        required: true
      versionBump:
        description: Version bump
        type: choice
        options:
          - patch
          - minor
          - major
      artemisSoftUpdate:
        description: Artemis SBS latest version
      artemisRequiredUpdate:
        description: Version required to support Artemis
        type: boolean
      securityRequiredUpdate:
        description: Version required for security
        type: boolean

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  wait-for-prerequisites:
    name: 'Wait for prerequisite actions'
    runs-on: ubuntu-latest
    steps:
      - name: Wait for build
        uses: ArcticLampyrid/action-wait-for-workflow@v1.2.0
        with:
          workflow: gradle.yml
          wait-interval: 5

      - name: Wait for instrumented tests
        uses: ArcticLampyrid/action-wait-for-workflow@v1.2.0
        with:
          workflow: instrumented-tests.yml
          wait-interval: 5

  release:
    runs-on: ubuntu-latest
    needs: wait-for-prerequisites
    environment: Production
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.RELEASE_PAT }}

      - name: Generate secret files
        run: |
          echo ${{ secrets.KEYSTORE_PROPERTIES }} | base64 -d > ${{ github.workspace }}/keystore.properties
          echo ${{ secrets.KEYSTORE_FILE }} | base64 -d > ${{ github.workspace }}/app/artemis-agent-keystore.jks
          echo ${{ secrets.GOOGLE_SERVICES }} | base64 -d > ${{ github.workspace }}/app/google-services.json
          echo ${{ secrets.FASTLANE_JSON }} | base64 -d > ${{ github.workspace }}/app/artemis-agent-fastlane.json

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      # Configure Gradle for optimal use in GitHub Actions, including caching of downloaded dependencies.
      # See: https://github.com/gradle/actions/blob/main/setup-gradle/README.md
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4

      - name: Get app version code
        id: version
        uses: ltDino/android-get-version-action@v1.0
        with:
          gradlePath: app/build.gradle.kts

      - name: Increment app version code
        id: nextVersion
        run: echo "versionCode=$((${{ steps.version.outputs.versionCode }}+1))" >> "$GITHUB_OUTPUT"

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: 3.2.2
          bundler-cache: true

      - name: Initialize Fastlane
        run: bundle exec fastlane supply init

      - name: Update changelog
        run: |
          rm fastlane/metadata/android/en-US/changelogs/*.txt
          echo "${{ vars.CHANGELOG }}" > fastlane/metadata/android/en-US/changelogs/default.txt

      - name: Authenticate for Firebase
        if: ${{ inputs.securityRequiredUpdate || inputs.artemisRequiredUpdate || inputs.artemisSoftUpdate }}
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: projects/${{ secrets.WIF_PROJECT_ID }}/locations/global/workloadIdentityPools/${{ secrets.WIF_POOL }}/providers/${{ secrets.WIF_PROVIDER }}
          service_account: ${{ secrets.FIREBASE_SA_USER }}@${{ secrets.FIREBASE_SA_PROJECT }}.iam.gserviceaccount.com

      - name: Set Firebase Project
        if: ${{ inputs.securityRequiredUpdate || inputs.artemisRequiredUpdate || inputs.artemisSoftUpdate }}
        uses: w9jds/firebase-action@v14.1.0
        with:
          args: use ${{ secrets.FIREBASE_SA_PROJECT }}

      - name: Get Firebase Remote Config
        if: ${{ inputs.securityRequiredUpdate || inputs.artemisRequiredUpdate || inputs.artemisSoftUpdate }}
        uses: w9jds/firebase-action@v14.1.0
        with:
          args: remoteconfig:get -o app/remote-config.json

      - name: Obtain Ownership
        if: ${{ inputs.securityRequiredUpdate || inputs.artemisRequiredUpdate || inputs.artemisSoftUpdate }}
        run: sudo chown -R $(whoami):$(id -g) app/remote-config.json

      - name: Update Artemis Version Parameter
        if: ${{ inputs.artemisSoftUpdate }}
        uses: jossef/action-set-json-field@v2.2
        with:
          file: app/remote-config.json
          field: parameters.artemis_latest_version.conditionalValues.Everyone.rolloutValue.value
          value: ${{ inputs.artemisSoftUpdate }}

      - name: Update Version Code for Artemis Parameter
        if: ${{ inputs.artemisRequiredUpdate }}
        uses: jossef/action-set-json-field@v2.2
        with:
          file: app/remote-config.json
          field: parameterGroups.required_versions.parameters.required_version_artemis.conditionalValues.Everyone.rolloutValue.value
          value: ${{ steps.nextVersion.outputs.versionCode }}

      - name: Update Version Code for Security Parameter
        if: ${{ inputs.securityRequiredUpdate }}
        uses: jossef/action-set-json-field@v2.2
        with:
          file: app/remote-config.json
          field: parameterGroups.required_versions.parameters.required_version_security.conditionalValues.Everyone.rolloutValue.value
          value: ${{ steps.nextVersion.outputs.versionCode }}

      - name: Publish Firebase Remote Config
        if: ${{ inputs.securityRequiredUpdate || inputs.artemisRequiredUpdate || inputs.artemisSoftUpdate }}
        uses: w9jds/firebase-action@v14.1.0
        with:
          args: deploy --only remoteconfig

      - name: Bundle and Upload
        run: bundle exec fastlane android deploy version:${{ inputs.versionName }}

      - name: Update README
        run: |
          var="${{ inputs.versionName }}"
          sed -i "1s/.*/# Artemis Agent $var/" ${{ github.workspace }}/README.md

      - name: Commit
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: Release version ${{ inputs.versionName }}
          commit_options: "--no-verify --signoff"
          commit_user_name: ${{ github.triggering_actor }}
          commit_user_email: ${{ github.triggering_actor }}@users.noreply.github.com
          branch: main
          add_options: "-u"

      - name: Tag
        id: tag
        uses: mathieudutour/github-tag-action@v6.2
        with:
          github_token: ${{ secrets.RELEASE_PAT }}
          default_bump: ${{ inputs.versionBump }}

      - name: Release
        uses: ncipollo/release-action@v1
        with:
          tag: ${{ steps.tag.outputs.new_tag }}
          name: ${{ steps.tag.outputs.new_tag }}
          body: |
            ${{ vars.CHANGELOG }}
            ### [Google Play](https://play.google.com/store/apps/details?id=artemis.agent)
